<style>
  .steps-container{display:table}
  .slider-container>*{vertical-align: middle}
  .btn{display:table-cell; width:20px; background:#333; text-align: center; border: solid 2px #999; cursor: pointer; height:20px}
  .active .btn{background:#aaa}
  .active .slider{ opacity: 0.7}
  .disp-note{ color:#eee;opacity: 0.2;width:30px;display: inline-block;text-align: right}
  .active .disp-note{ opacity: 1}

  .beat {background:#333}
  .beat.active{background:#666}
  
  .slider {
    -webkit-appearance: none;
    height: 22px;
    width:240px;
    background: #333;
    outline: none;
    opacity: 0.7;
    -webkit-transition: .2s;
    transition: opacity .2s;
    margin:0;
  }
  .slider:hover {
    opacity: 1;
  }
  .active .slider::-webkit-slider-thumb{
    opacity: 1;
  }
  .slider::-webkit-slider-thumb {
      opacity: 0.1;
      -webkit-appearance: none;
      appearance: none;
      width: 22px;
      height: 22px;
      background: #eee;
      cursor: pointer;
  }
</style>
<body style="background:#111; margin:0">
<select id="select-midi-output-device"></select>
<select id="select-midi-output-ch"></select>

<div class="" onclick="tmrOff()">STOP</div>
<div class="" onclick="play()">PLAY</div>
<div style="width:330px; margin:auto">
  <div class="slider-container sc00">
    <div class="disp-note" id="dispNote00">0</div>
    <input class="slider" id="noteSlider00" type="range" min="0" max="40" value="0" onclick="btnOn(this)" >
    <div class="btn b00" style="display:inline-block" onclick="btn(this)"></div>
  </div>
  <div class="slider-container sc01">
    <div class="disp-note" id="dispNote01">0</div>
    <input class="slider" id="noteSlider01" type="range" min="0" max="40" value="0" onclick="btnOn(this)" >
    <div class="btn b01" style="display:inline-block" onclick="btn(this)"></div>
  </div>
  <div class="slider-container sc02">
    <div class="disp-note" id="dispNote02">0</div>
    <input class="slider" id="noteSlider02" type="range" min="0" max="40" value="0" onclick="btnOn(this)" >
    <div class="btn b02" style="display:inline-block" onclick="btn(this)"></div>
  </div>
  <div class="slider-container sc03">
    <div class="disp-note" id="dispNote03">0</div>
    <input class="slider" id="noteSlider03" type="range" min="0" max="40" value="0" onclick="btnOn(this)" >
    <div class="btn b03" style="display:inline-block" onclick="btn(this)"></div>
  </div>
  <div class="slider-container sc04">
    <div class="disp-note" id="dispNote04">0</div>
    <input class="slider" id="noteSlider04" type="range" min="0" max="40" value="0" onclick="btnOn(this)" >
    <div class="btn b04" style="display:inline-block" onclick="btn(this)"></div>
  </div>
  <div class="slider-container sc05">
    <div class="disp-note" id="dispNote05">0</div>
    <input class="slider" id="noteSlider05" type="range" min="0" max="40" value="0" onclick="btnOn(this)" >
    <div class="btn b05" style="display:inline-block" onclick="btn(this)"></div>
  </div>
  <div class="slider-container sc06">
    <div class="disp-note" id="dispNote06">0</div>
    <input class="slider" id="noteSlider06" type="range" min="0" max="40" value="0" onclick="btnOn(this)" >
    <div class="btn b06" style="display:inline-block" onclick="btn(this)"></div>
  </div>
  <div class="slider-container sc07">
    <div class="disp-note" id="dispNote07">0</div>
    <input class="slider" id="noteSlider07" type="range" min="0" max="40" value="0" onclick="btnOn(this)" >
    <div class="btn b07" style="display:inline-block" onclick="btn(this)"></div>
  </div>
  <div class="slider-container sc08">
    <div class="disp-note" id="dispNote08">0</div>
    <input class="slider" id="noteSlider08" type="range" min="0" max="40" value="0" onclick="btnOn(this)" >
    <div class="btn b08" style="display:inline-block" onclick="btn(this)"></div>
  </div>
  <div class="slider-container sc09">
    <div class="disp-note" id="dispNote09">0</div>
    <input class="slider" id="noteSlider09" type="range" min="0" max="40" value="0" onclick="btnOn(this)" >
    <div class="btn b09" style="display:inline-block" onclick="btn(this)"></div>
  </div>
  <div class="slider-container sc10">
    <div class="disp-note" id="dispNote10">0</div>
    <input class="slider" id="noteSlider10" type="range" min="0" max="40" value="0" onclick="btnOn(this)" >
    <div class="btn b10" style="display:inline-block" onclick="btn(this)"></div>
  </div>
  <div class="slider-container sc11">
    <div class="disp-note" id="dispNote11">0</div>
    <input class="slider" id="noteSlider11" type="range" min="0" max="40" value="0" onclick="btnOn(this)" >
    <div class="btn b11" style="display:inline-block" onclick="btn(this)"></div>
  </div>
  <div class="slider-container sc12">
    <div class="disp-note" id="dispNote12">0</div>
    <input class="slider" id="noteSlider12" type="range" min="0" max="40" value="0" onclick="btnOn(this)" >
    <div class="btn b12" style="display:inline-block" onclick="btn(this)"></div>
  </div>
  <div class="slider-container sc13">
    <div class="disp-note" id="dispNote13">0</div>
    <input class="slider" id="noteSlider13" type="range" min="0" max="40" value="0" onclick="btnOn(this)" >
    <div class="btn b13" style="display:inline-block" onclick="btn(this)"></div>
  </div>
  <div class="slider-container sc14">
    <div class="disp-note" id="dispNote14">0</div>
    <input class="slider" id="noteSlider14" type="range" min="0" max="40" value="0" onclick="btnOn(this)" >
    <div class="btn b14" style="display:inline-block" onclick="btn(this)"></div>
  </div>
  <div class="slider-container sc15">
    <div class="disp-note" id="dispNote15">0</div>
    <input class="slider" id="noteSlider15" type="range" min="0" max="40" value="0" onclick="btnOn(this)" >
    <div class="btn b15" style="display:inline-block" onclick="btn(this)"></div>
  </div>
</div>


<script>

const noteSlider00 = document.getElementById("noteSlider00")
const noteSlider01 = document.getElementById("noteSlider01")
const noteSlider02 = document.getElementById("noteSlider02")
const noteSlider03 = document.getElementById("noteSlider03")
const noteSlider04 = document.getElementById("noteSlider04")
const noteSlider05 = document.getElementById("noteSlider05")
const noteSlider06 = document.getElementById("noteSlider06")
const noteSlider07 = document.getElementById("noteSlider07")
const noteSlider08 = document.getElementById("noteSlider08")
const noteSlider09 = document.getElementById("noteSlider09")
const noteSlider10 = document.getElementById("noteSlider10")
const noteSlider11 = document.getElementById("noteSlider11")
const noteSlider12 = document.getElementById("noteSlider12")
const noteSlider13 = document.getElementById("noteSlider13")
const noteSlider14 = document.getElementById("noteSlider14")
const noteSlider15 = document.getElementById("noteSlider15")

const sliderValOut00 = document.getElementById("dispNote00")
const sliderValOut01 = document.getElementById("dispNote01")
const sliderValOut02 = document.getElementById("dispNote02")
const sliderValOut03 = document.getElementById("dispNote03")
const sliderValOut04 = document.getElementById("dispNote04")
const sliderValOut05 = document.getElementById("dispNote05")
const sliderValOut06 = document.getElementById("dispNote06")
const sliderValOut07 = document.getElementById("dispNote07")
const sliderValOut08 = document.getElementById("dispNote08")
const sliderValOut09 = document.getElementById("dispNote09")
const sliderValOut10 = document.getElementById("dispNote10")
const sliderValOut11 = document.getElementById("dispNote11")
const sliderValOut12 = document.getElementById("dispNote12")
const sliderValOut13 = document.getElementById("dispNote13")
const sliderValOut14 = document.getElementById("dispNote14")
const sliderValOut15 = document.getElementById("dispNote15")

noteSlider00.oninput = function() {sliderValOut00.innerHTML = this.value}
noteSlider01.oninput = function() {sliderValOut01.innerHTML = this.value}
noteSlider02.oninput = function() {sliderValOut02.innerHTML = this.value}
noteSlider03.oninput = function() {sliderValOut03.innerHTML = this.value}
noteSlider04.oninput = function() {sliderValOut04.innerHTML = this.value}
noteSlider05.oninput = function() {sliderValOut05.innerHTML = this.value}
noteSlider06.oninput = function() {sliderValOut06.innerHTML = this.value}
noteSlider07.oninput = function() {sliderValOut07.innerHTML = this.value}
noteSlider08.oninput = function() {sliderValOut08.innerHTML = this.value}
noteSlider09.oninput = function() {sliderValOut09.innerHTML = this.value}
noteSlider10.oninput = function() {sliderValOut10.innerHTML = this.value}
noteSlider11.oninput = function() {sliderValOut11.innerHTML = this.value}
noteSlider12.oninput = function() {sliderValOut12.innerHTML = this.value}
noteSlider13.oninput = function() {sliderValOut13.innerHTML = this.value}
noteSlider14.oninput = function() {sliderValOut14.innerHTML = this.value}
noteSlider15.oninput = function() {sliderValOut15.innerHTML = this.value}

var step = 0;

function btn(ele) {
  // ele.classList.toggle('active');
  ele.parentNode.classList.toggle('active');
}
function btnOn(ele) {
  ele.parentNode.classList.add('active');
}


let preNote;
function trigger(num) {
  sendNoteOff(preNote)
  num = ('00' + num).slice(-2);
  var target = document.getElementsByClassName( "slider-container sc" + num);
  var targetNote = document.getElementById("noteSlider" + num);
  if(target[0].classList.contains('active')){
    sendNote(targetNote.value);
    preNote = targetNote.value;
  }else{
    sendNoteOff(num)
  }
}

//タイマーを格納する変数の宣言
var timer1;
var step = 0;
play();
//setInterval()を使ったタイマーの起動関数
function play(){
  timer1 = setInterval("tmrOn()",469/4);
}
function tmrOn(){
  step = (step + 1)%16;
  trigger(step);
  beatDisp();
}
function tmrOff(){
  clearInterval(timer1);
}


// 現在拍表示
function beatDisp(){
  var beats = document.getElementsByClassName( "slider-container" );
  beats[step].classList.add('beat');
  if(step==0){
    beats[15].classList.remove('beat');
  }else{
    beats[step-1].classList.remove('beat');
  }
}

</script>


<script>
navigator.requestMIDIAccess().then(onMIDISuccess,onMIDIFailure);
var midi = null;
var inputs = [];
var outputs = [];
var output = null;
var chs = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16];
var ch = 1;

/////////////////////////////////////////////////////////////////////////////

function onMIDISuccess(m){
  midi = m;
  var it = midi.inputs.values();
  for(var o = it.next(); !o.done; o = it.next()){
    inputs.push(o.value);
  }
  var ot = midi.outputs.values();
  for(var o = ot.next(); !o.done; o = ot.next()){
    outputs.push(o.value);
  }
  
  output = outputs[0];
  outputs.forEach(function(element, index) {
    var option = document.createElement('option');
    option.appendChild(document.createTextNode(element.name));
    option.setAttribute('value', index);
    document.getElementById('select-midi-output-device').appendChild(option);
  });
  document.getElementById('select-midi-output-device').onchange = function() {
    output = outputs[this.value];
  };  
  for(var cnt=0;cnt < inputs.length;cnt++){
    inputs[cnt].onmidimessage = onMIDIEvent;
  }
}

chs.forEach(function(value, index) {
  var option = document.createElement('option');
  option.appendChild(document.createTextNode(value));
  option.setAttribute('value', index);
  document.getElementById('select-midi-output-ch').appendChild(option);
});
document.getElementById('select-midi-output-ch').onchange = function() {
  ch = chs[this.value];
};

function onMIDIEvent(e){
  if(e.data[2] != 0){ 
    // なにかをうけとったときの処理
    // console.log(e.data[2]);
    // console.log(e.data[1]);
  }
}

function onMIDIFailure(){
  console.log("munen!");
};

function sendCC(cc, val){
  // if(outputs.length > 0){
  //   outputs[0].send([0xB0, cc, val]);
  // }
  if(output){
    output.send([0xB0 + ch-1, cc, val]);
  }
}

function sendNote(note){
  if(output){
    outputs[0].send([0x90,note,0x7f]);
  }
}

function sendNoteOff(note){
  if(output){
    outputs[0].send([0x80,note,0x7f]);
  }
}


/////////////////////////////////////////////////////////////////////////////
</script>


  
</body>